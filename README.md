# Модель прогнозирования оттока клиентов для веб-сервиса

Данный репозиторий содержит систему прогнозирования оттока клиентов, реализованную на ЯП Python, которая объединяет сверточные нейронные сети (CNN), сети с долгосрочной краткосрочной памятью (LSTM) и графовые нейронные сети (GNN) в гибридную нейронную сеть для предсказания оттока клиентов на основе данных о клиентах, транзакциях и событиях. Проект включает предварительную обработку данных, создание признаков, обучение модели и предсказание с вычислением SHAP-значений для интерпретации результатов. 

Проект был разработан в рамках ВКР студентом Кардаковым М.Д. в 2025 году.

## Структура проекта

Ниже представлено краткое описание каждого файла, его условий работы и функционала.

### 1. `data_collector.py`
- Назначение: Загружает и проверяет данные клиентов из CSV-файла.
- Функциональность:
  - Читает данные клиентов из `client_data.csv`.
  - Проверяет наличие обязательных столбцов и типов данных.
  - Обрабатывает пропущенные значения и обеспечивает целостность данных (например, уникальность `client_id`, корректные значения `churn`, допустимые значения `gender`).
- Основной класс: `DataCollector`
  - Инициализируется с экземпляром `Logger` для отслеживания прогресса.
  - Метод `collect_data(data_file)` возвращает очищенный DataFrame Pandas.

### 2. `preprocessor.py`
- **Назначение**: Очищает и нормализует данные клиентов для ввода в модель.
- **Функциональность**:
  - Удаляет строки с пропущенными значениями.
  - Проверяет числовые и категориальные столбцы.
  - Преобразует `gender` в бинарный формат (male: 1, female: 0).
  - Нормализует числовые признаки (например, `age`, `cpi`, столбцы временных рядов) с использованием `RobustScaler`.
- **Основной класс**: `Preprocessor`
  - Инициализируется с экземпляром `Logger`.
  - Метод `preprocess(df)` возвращает предобработанный DataFrame.

### 3. `feature_engineering.py`
- **Назначение**: Генерирует признаки для гибридной модели, включая временные ряды, статические признаки и графовые признаки.
- **Функциональность**:
  - Вычисляет взаимодействующие признаки, такие как отношение транзакций к неактивности и показатель лояльности.
  - Применяет нелинейные преобразования (логарифмические) к скошенным числовым признакам.
  - Генерирует признаки на основе распределения Вейбулла и метрики активности событий.
  - Создает графовые данные (индексы ребер и признаки узлов) на основе схожести клиентов.
  - Оптимизирует веса для показателя лояльности и построения графа с использованием кросс-валидации.
- **Основной класс**: `FeatureEngineer`
  - Инициализируется с `Logger`, количеством дней (`num_days`) и количеством признаков временных рядов (`ts_features`).
  - Метод `generate_features(df, transactions_file, events_file)` возвращает тензоры для временных рядов, статических признаков, индексов ребер и признаков узлов.

### 4. `hybrid_model.py`
- **Назначение**: Определяет гибридную модель CNN-LSTM-GNN для прогнозирования оттока.
- **Функциональность**:
  - Объединяет CNN для обработки временных рядов, LSTM для последовательных закономерностей и GNN для отношений между клиентами.
  - Включает L2-регуляризацию и выброс (dropout) для повышения устойчивости.
  - Проверяет формы входных тензоров и логирует ошибки.
- **Основной класс**: `HybridModel` (наследуется от `torch.nn.Module`)
  - Инициализируется с параметрами, такими как размер признаков узлов, количество статических признаков, индексы ребер и гиперпараметры (например, `cnn_filters`, `lstm_units`, `gnn_layers`).
  - Метод `forward(time_series, static_features, client_ids, node_features)` вычисляет предсказания модели.
  - Метод `compute_l2_regularization()` вычисляет член L2-регуляризации.

### 5. `train_model.py`
- **Назначение**: Обучает гибридную модель с оптимизацией гиперпараметров с использованием Optuna.
- **Функциональность**:
  - Загружает и предобрабатывает данные с использованием `DataCollector`, `Preprocessor` и `FeatureEngineer`.
  - Разделяет данные на обучающую и валидационную выборки.
  - Оптимизирует гиперпараметры (например, скорость обучения, размер батча, фильтры CNN) с помощью Optuna.
  - Обучает модель с лучшими гиперпараметрами и сохраняет её в `final_model.pth`.
  - Сохраняет лучшие гиперпараметры в `best_params.json`.
- **Основные функции**:
  - `train_model(data_file, transactions_file, events_file, model_path)`: Основная функция обучения.
  - `objective(trial, ...)`: Целевая функция для оптимизации гиперпараметров в Optuna.
  - `ChurnDataset`: Пользовательский датасет PyTorch для загрузки данных.

### 6. `model_predictor.py`
- **Назначение**: Загружает обученную модель и выполняет предсказания оттока, включая вычисление SHAP-значений.
- **Функциональность**:
  - Загружает обученную модель из `final_model.pth`.
  - Использует предобработанные данные и сгенерированные признаки для предсказания вероятностей оттока.
  - Вычисляет SHAP-значения для интерпретации модели.
  - Сохраняет предсказания в `predictions.csv` и SHAP-значения в `shap_values.csv`.
- **Основной класс**: `ModelPredictor`
  - Инициализируется с экземпляром `Logger`.
  - Метод `load_model(...)` загружает обученную модель.
  - Метод `compute_shap_values(...)` вычисляет SHAP-значения.
  - Метод `predict(data_file, transactions_file, events_file, model_path)` выполняет предсказания.

## Ожидаемые форматы CSV-файлов

Следующие CSV-файлы необходимы для работы проекта, но не включены в репозиторий из-за NDA. Ниже описаны их ожидаемые структуры:

### 1. `client_data.csv`
- **Описание**: Содержит данные на уровне клиентов, включая статические признаки и ежедневные данные временных рядов за 90 дней.
- **Обязательные столбцы**:
  - `client_id` (str): Уникальный идентификатор клиента.
  - `churn` (int): Бинарная метка (0 или 1), указывающая, ушёл ли клиент.
  - `age` (float): Возраст клиента.
  - `gender` (str): Пол клиента (`male` или `female`).
  - `cpi` (float): Индекс прибыльности клиента.
  - `registration_time` (str): Время регистрации (формат: `YYYY-MM-DD HH:MM:SS`).
  - Столбцы временных рядов (всего 360):
    - `bets_day1` до `bets_day90` (float): Количество ставок в день.
    - `amount_day1` до `amount_day90` (float): Суммы транзакций в день.
    - `wins_day1` до `wins_day90` (float): Выигрыши в день.
    - `losses_day1` до `losses_day90` (float): Проигрыши в день.
- **Примечания**: Все числовые столбцы должны содержать конечные значения. Пропущенные значения обрабатываются удалением строк.

### 2. `transactions.csv`
- **Описание**: Содержит записи о транзакциях клиентов.
- **Обязательные столбцы**:
  - `client_id` (str): Уникальный идентификатор, соответствующий `client_data.csv`.
  - `timestamp` (str): Время транзакции (формат: `YYYY-MM-DD HH:MM:SS`).
  - `promo_used` (int/float): Индикатор или количество использованных промо-акций.
- **Примечания**: Используется для вычисления интервалов между транзакциями и активности промо-акций для построения графа.

### 3. `events.csv`
- **Описание**: Содержит записи об участии клиентов в событиях.
- **Обязательные столбцы**:
  - `client_id` (str): Уникальный идентификатор, соответствующий `client_data.csv`.
  - (Дополнительные столбцы могут присутствовать, но не являются обязательными.)
- **Примечания**: Используется для вычисления признаков активности событий (например, количество событий на клиента).
